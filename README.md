# Usman Digital Academy - Supabase Setup

This project uses Supabase as its backend for database, authentication, and file storage. To run this project, you need to set up a free Supabase project and configure it as follows.

## 1. Create a Supabase Project

1.  Go to [supabase.com](https://supabase.com/) and sign up for a free account.
2.  Create a new project. Save your **Project URL** and **`anon` public key**.

## 2. Configure `services/supabase.ts`

In the file `services/supabase.ts`, replace the placeholder values with your actual Supabase Project URL and anon key.

```typescript
// services/supabase.ts

const supabaseUrl = 'YOUR_SUPABASE_URL'; // <-- Replace this
const supabaseAnonKey = 'YOUR_SUPABASE_ANON_KEY'; // <-- Replace this
```

## 3. Database Schema

Go to the "SQL Editor" in your Supabase dashboard and run the following queries to create the necessary tables.

### `profiles` table
Stores public user data and roles.

```sql
-- Create the profiles table
create table public.profiles (
  id uuid not null references auth.users on delete cascade,
  name varchar,
  role text default 'user',
  primary key (id)
);

-- Set up Row Level Security (RLS)
alter table public.profiles
  enable row level security;

create policy "Users can view their own profile." on public.profiles
  for select using (auth.uid() = id);

create policy "Users can update their own profile." on public.profiles
  for update using (auth.uid() = id);

-- Function to create a profile when a new user signs up
create function public.handle_new_user()
returns trigger as $$
begin
  insert into public.profiles (id, name, role)
  values (new.id, new.raw_user_meta_data->>'name', 'user');
  return new;
end;
$$ language plpgsql security definer;

-- Trigger to call the function on new user creation
create trigger on_auth_user_created
  after insert on auth.users
  for each row execute procedure public.handle_new_user();
```
**Note:** To make a user an admin, you can manually update their `role` in the `profiles` table from `user` to `admin`.

### `courses` table
Stores course information.

```sql
-- Create the courses table
create table public.courses (
  id bigint generated by default as identity primary key,
  title text not null,
  category text,
  description text,
  learning_outcomes text[],
  price float8,
  image_url text,
  instructor text,
  created_at timestamptz default now()
);

-- Set up Row Level Security (RLS)
alter table public.courses
  enable row level security;

create policy "Courses are publicly viewable." on public.courses
  for select using (true);

create policy "Admins can manage courses." on public.courses
  for all using (
    (select role from public.profiles where id = auth.uid()) = 'admin'
  );
```

### `purchases` table
Stores student course purchases.

```sql
-- Create the purchases table
create table public.purchases (
  id bigint generated by default as identity primary key,
  user_id uuid not null references public.profiles,
  course_id bigint not null references public.courses on delete cascade,
  status text check (status in ('Pending Confirmation', 'Access Granted')),
  created_at timestamptz default now()
);

-- Set up Row Level Security (RLS)
alter table public.purchases
  enable row level security;

create policy "Users can view their own purchases." on public.purchases
  for select using (auth.uid() = user_id);

create policy "Users can create their own purchases." on public.purchases
  for insert with check (auth.uid() = user_id);

create policy "Admins can manage all purchases." on public.purchases
  for all using (
    (select role from public.profiles where id = auth.uid()) = 'admin'
  );
```

## 4. File Storage

1.  Go to the "Storage" section in your Supabase dashboard.
2.  Create a new bucket named `course-images`.
3.  Make the bucket **public** by clicking the three dots next to the bucket name -> "Bucket settings" and toggling "Public bucket".
4.  Set up storage policies by going to "Policies" under the `course-images` bucket. Create the following policies:

    *   **Allow public read access:**
        *   Policy Name: `Public Read Access`
        *   Allowed operations: `select`
        *   Target roles: `anon`, `authenticated`
        *   With policy: `(bucket_id = 'course-images')`

    *   **Allow admins to upload/update/delete:**
        *   Policy Name: `Admin Manage Access`
        *   Allowed operations: `insert`, `update`, `delete`
        *   Target roles: `authenticated`
        *   With policy: `(bucket_id = 'course-images' AND (SELECT role FROM public.profiles WHERE id = auth.uid()) = 'admin')`

That's it! Your Supabase backend is now configured to work with the application.
